# To-Do List for WebSocket-Service (FastAPI + Redis Pub/Sub)

## 1. Проектирование и подготовка окружения

- [ ] **1.1. Настройка Docker Compose**
  - [ ] Создать `docker-compose.yml` с сервисами:
    - `app` (FastAPI + Uvicorn)
    - `redis` (официальный образ)
  - [ ] Настроить общую сеть и при необходимости тома
  - [ ] Проверить: `docker-compose up -d` стартует оба сервиса без ошибок

- [ ] **1.2. Конфигурация проекта FastAPI**
  - [ ] Инициализировать виртуальное окружение (`python -m venv .venv`)
  - [ ] Установить зависимости: `fastapi`, `uvicorn`, `aioredis`, `python-dotenv`
  - [ ] Создать структуру каталогов:
    ```
    app/
    ├── main.py
    ├── ws.py
    ├── workers.py
    ├── config.py
    └── requirements.txt
    ```
  - [ ] Проверить: приложение запускается командой `uvicorn app.main:app --reload`

- [ ] **1.3. Подготовка конфигурации**
  - [ ] Создать файл `.env` (или `config.yaml`) с параметрами:
    - `APP_PORT`
    - `REDIS_URL`
  - [ ] Реализовать загрузку конфигурации в `config.py` через `python-dotenv`
  - [ ] Проверить: настройки успешно читаются в любом модуле

- [ ] **1.4. Инициализация репозитория**
  - [ ] Инициализировать Git-репозиторий (`git init`)
  - [ ] Добавить `.gitignore` (Python, Docker)
  - [ ] Создать `README.md` с кратким описанием проекта и командами запуска
  - [ ] Проверить: `git status` чист, все файлы в коммите

---

## 2. Реализация WebSocket-сервера

- [ ] **2.1. Создать endpoint `/ws` в `ws.py`**
  - [ ] Обработать соединение:
    - `on_connect`
    - `on_disconnect`
  - [ ] Приём бинарных аудио-чанков в `websocket.receive_bytes()`
  - [ ] Проверить: клиент может подключиться и отправить сообщение

- [ ] **2.2. Публикация в Redis**
  - [ ] Настроить асинхронный клиент Redis (`aioredis`) в `ws.py`
  - [ ] Публиковать каждый аудио-чанк в канал `audio_chunks`
  - [ ] Проверить: данные доходят до Redis (`redis-cli SUBSCRIBE audio_chunks`)

- [ ] **2.3. Отправка ответов клиенту**
  - [ ] Подписаться на канал `transcripts` (в рамках каждой WS-сессии или централизовано)
  - [ ] При получении транскрипта отправлять JSON: `{ "client_id": ..., "text": ... }`
  - [ ] Проверить: клиент получает корректный JSON-ответ

---

## 3. Настройка Redis Pub/Sub

- [ ] **3.1. Определить каналы**
  - [ ] `audio_chunks`
  - [ ] `transcripts`

- [ ] **3.2. Конфигурация `aioredis`**
  - [ ] Настроить подключение с параметром `REDIS_URL`
  - [ ] Создать утилитный модуль `redis_client.py` для общего использования
  - [ ] Проверить: подключение успешно (`await redis.ping()` возвращает `PONG`)

---

## 4. Фоновый воркер для mock-транскрипции

- [ ] **4.1. Реализация `workers.py`**
  - [ ] Подписаться на канал `audio_chunks`
  - [ ] Для каждого полученного сообщения:
    - [ ] Слать фиктивный транскрипт: например, `"Transcribed: <timestamp>"`
    - [ ] Публиковать в канал `transcripts`
  - [ ] Обрабатывать возможные ошибки и логировать их
  - [ ] Проверить: при отправке чанка из Redis-cli воркер публикует транскрипт

- [ ] **4.2. Запуск воркера**
  - [ ] Добавить команду в `docker-compose.yml` или shell-скрипт для старта воркера
  - [ ] Проверить: воркер запускается и обрабатывает сообщения

---

## 5. Интеграция и обратная доставка транскриптов

- [ ] **5.1. Подписка WS-сервера на канал `transcripts`**
  - [ ] Реализовать логику прослушивания транскриптов
  - [ ] Связать клиентский `client_id` с сообщениями
  - [ ] Проверить: end-to-end сценарий (клиент→Redis→воркер→Redis→клиент)

- [ ] **5.2. Валидация и обработка ошибок**
  - [ ] Проверять формат входящих и исходящих данных
  - [ ] Возвращать клиенту понятное сообщение об ошибке, если что-то пошло не так
  - [ ] Логировать ошибки в консоль или файл

---

## 6. Тестирование и отладка

- [ ] **6.1. Юнит-тесты**
  - [ ] Тесты для публикации/подписки Redis (моки)
  - [ ] Тесты для обработчиков WS (connect/disconnect)

- [ ] **6.2. Интеграционные тесты**
  - [ ] Эмуляция WS-клиентов (например, `websockets` или `starlette.testclient`)
  - [ ] Проверить корректность передачи и получения транскриптов

- [ ] **6.3. Нагрузочное тестирование**
  - [ ] Запустить несколько клиентов (например, `locust` или скрипт на asyncio)
  - [ ] Оценить устойчивость при параллельных соединениях

---

## 7. Документация и сборка

- [ ] Обновить `README.md`:
  - [ ] Описание сервиса и архитектуры
  - [ ] Команды для запуска через Docker Compose
  - [ ] Примеры WS-запросов и ответов
  - [ ] Переменные окружения и конфигурация

- [ ] Финальная проверка:
  - [ ] Все чекауты в проекте сделаны
  - [ ] CI/CD (опционально) настроен на автоматический линтинг и тесты